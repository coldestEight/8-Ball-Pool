<!DOCTYPE html>
<html>

<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <style>
        .svg-container {
            width: 500px;
            height: auto;
            border: 5px solid black;
            float: left;
        }

        .menu{
            float: left;
            padding: 15px;
        }

        .turn-indicator{
            font-size: 25px;
        }
    </style>

    <script>

        track = false
        clicked = false
        processing = false
        cuex = 0
        cuey = 0
        time = 0
        svg = ""
        shotID = 0
        numFrames = 0
        player1Name = ""
        player2Name = ""
        playerTurn = 0
        high = 0
        low = 0

        function trackon(event) {
            track = true;
        }

        function trackoff(event) {

            if (clicked == true) {

                x = 15 * (cuex - (event.pageX-50))
                y = 15 * (cuey - (event.pageY-50))

                shoot(x, y)
            }

            track = false
            clicked = false
            $("line:first").remove()
        }

        function clickBall() {
            clicked = true
            cuex = $("#qball").attr("cx") / 3.5 + 9
            cuey = $("#qball").attr("cy") / 3.5
        }

        function trackit(event) {
            if (track && clicked) {

                svg = $("svg:first")
                $("line:first").remove()

                svgX = event.pageX
                svgY = event.pageY

                x = 10 * (cuex - event.pageX)
                y = 10 * (cuey - event.pageY)

                line = document.createElementNS("http://www.w3.org/2000/svg", 'line')

                line.setAttribute("x1", (cuex - 9) * 3.5)
                line.setAttribute("y1", cuey * 3.5)
                line.setAttribute("x2", (svgX-100)*(4.3))
                line.setAttribute("y2", (svgY-100)*4.3)
                line.setAttribute("stroke", "#edbc6d")
                line.setAttribute("stroke-width", '20')
                line.setAttribute("stroke-linecap", "round")

                $(svg).append(line)

            }
        }


        function setupBoard() {
            value = $.get("/setupBoard")
            value.then(function (v) {
                data = JSON.parse(v)

                player1Name = data.player1Name
                player2Name = data.player2Name
                playerTurn = data.turn

                $("div.svg-container").html(data.table)  
                setTurn()              
            })
        }

        function setTurn(){

            if(playerTurn == 1){
                if(high == 1){

                    text = player1Name + "(High)"
                }
                else if (low == 1){

                    text = player1Name + "(Low)"
                }
                else{
                    text  = player1Name
                }
            }
            else{
                if(high == 2){

                    text = player2Name + "(High)"
                }
                else if (low == 2){

                    text = player2Name + "(Low)"
                }
                else{
                    text  = player2Name
                }
            }

            $("p.turn-indicator").html(text)
        }

        function shoot(xvel, yvel) {

            //$.post("/shoot", {velx: xvel, vely: yvel})
            //watch here if desync issues happen (forshadowing maybe?)
            $.ajax({
                url: "/shoot",
                data: { "velx": xvel, "vely": yvel },
                async: false,
                type: "POST"
            }).done(function (v) {

                setShotID(v)
                console.log("shotID " + shotID)

                $.ajax({
                    url: "/frames",
                    data: { "shotID": shotID },
                    async: false,
                    type: "POST"
                }).done(function (v) {

                    setFrames(v)
                    console.log("numFrames: "+numFrames)


                    $.ajax({
                        url: "/anim",
                        async: false,
                        type: "GET"
                    }).done(function (v) {

                        data = JSON.parse(v)

                        console.log(data)
                        for (let i = 0; i < data.frameCount; i++) {
                            setTimeout(function () { $("div.svg-container").html(data.frames[i]) }, i * 30)
                        }

                        setTimeout(function(){
                            $.ajax({
                            url: "/checkTable",
                            async: false,
                            type: "GET"
                            }).done(function(v){
                                tableData = JSON.parse(v)
                                console.log(tableData)
                                playerTurn = tableData.turn
                                high = tableData.high
                                low = tableData.low
                                setTurn()
                                $("div.svg-container").html(tableData.table)    
                            })}, data.frameCount*30);

                    })
                })
            })
        }

        function setShotID(sID) {

            shotID = sID
        }

        function setFrames(fr) {

            numFrames = fr
        }


    </script>

</head>

<body onload="setupBoard()">

    <div class="svg-container" onmousedown="trackon(event);" onmouseup="trackoff(event);" onmousemove="trackit(event);">
    </div>

    <div class="menu">
        
        <p class="turn-indicator">Player Name's Turn! </p>

        <p>High Balls Remaining: img</p>

        <p>Low Balls Remaining: img</p>

        <button>Reset</button>
        <button>Go Back</button>

    </div>
        


</body>


</html>